# GitHub Copilot Code Generation Instructions

## 0. Context & Ground Rules

This repo already contains a **mostly complete implementation** of Talk-To-My-Lawyer:

- Next.js App Router (TypeScript, SSR, Server Actions)
- Supabase (Auth, PostgreSQL, RLS)
- Stripe (subscriptions + letter allowances)
- AI letter generation
- Free trial system
- Employee coupons + commission tracking
- Secure admin portal at `/secure-admin-gateway`

**Do not rebuild the app.**  
Always extend, wire up, or harden the **existing** code.

---

## 1) Tech Stack (As Implemented)

### Core

- **Next.js** (App Router, `app/` directory – see `package.json` for exact versions)
- **React + TypeScript**
- **Tailwind CSS + shadcn/ui** for UI components
- **Supabase**
  - Auth: email/password signups and logins
  - Database: PostgreSQL with migrations in `supabase/migrations/*.sql`
  - RLS policies and Postgres functions for business logic
- **Stripe**
  - Checkout sessions
  - Webhook/verification via `app/api/verify-payment/route.ts`

### AI Provider – Target State

- **Current code:** uses **Google Gemini** directly via `fetch` in:
  - `app/api/generate-letter/route.ts`
  - `app/api/letters/[id]/improve/route.ts`
- **Required direction:** migrate to **OpenAI via Vercel AI SDK**, and then:
  - **Stop using Gemini entirely.**
  - Do not add any new Gemini-based code.

Target dependencies (add to `package.json` if missing):

```jsonc
"dependencies": {
  "ai": "latest",
  "@ai-sdk/openai": "latest"
}
```

### File Structure

- Main app routes: `/app`
- Subscriber/employee dashboards: `/app/dashboard/...`
- Secure admin portal: `/app/secure-admin-gateway/...`
- Supabase helpers: `/lib/supabase/...`
- Auth helpers: `/lib/auth/...`
- Components: `/components/...`
- Database migrations: `/scripts/*.sql` and `/supabase/migrations/*.sql`

### Existing Database Schema

The following tables already exist (do NOT drop, recreate, or rename):

- `profiles` - User accounts with roles
- `letters` - Legal letter documents
- `letter_audit_trail` - Audit log for letter reviews
- `subscriptions` - User subscription plans
- `commissions` - Employee commission tracking
- `employee_coupons` - Employee discount codes
- `coupon_usage` - Coupon usage tracking
- `security_audit_log` - Security event logging
- `security_config` - Security configuration settings

**Keep existing columns and semantics intact. Only extend via new migrations.**

---

## 2) ALIGN WITH CURRENT SECURE ADMIN PORTAL

### Secure Admin Gateway

You previously implemented a secure admin gateway with:
- Admin login at `/secure-admin-gateway/login`
- Dual authentication: email/password + portal key
- Separate admin session handling (short timeout, isolated from normal users)
- Middleware protection for admin routes
- Dark-themed admin dashboard under `/secure-admin-gateway/dashboard`
- Environment variables for admin credentials and portal key

**All of this must remain as-is. Do not weaken this design.**

### Admin Entry Points

- The ONLY admin entry point is `/secure-admin-gateway/login`
- Admins are NOT created via public signup
- Admin behavior is layered on top of this secure portal

---

## 3) ROLES & ACCESS MODEL

Use `profiles.role` and `profiles.is_super_user` from the existing schema.

### Role Definitions

**`role = 'subscriber'`**

- Normal end-users
- Land on `/dashboard`
- Can create and view ONLY their own letters

**`role = 'employee'`**
- Employee/affiliate
- Use existing employee views under `/dashboard`:
  - Commissions tab
  - Coupons tab
- CANNOT access letters (critical security requirement)

**`role = 'admin'` AND `is_super_user = false`**
- Reviewer / lawyer
- Can log in via the secure admin gateway
- After login, land in Review Center
- Cannot access super-admin-only sections (configs, system logs, user management)

**`role = 'admin'` AND `is_super_user = true`**
- Super admin / owner
- Uses the same secure gateway login
- After login, see main admin dashboard
- Can access:
  - Full review center
  - User management (promote users)
  - Employee overviews
  - Coupons/commissions analytics
  - Security / config views

### Admin Creation

Admins are NOT created via signup. They are either:
- Seeded in the database (initial super admin), or
- Promoted from existing users by the super admin via the UI

---

## 4) ROLE-AWARE ROUTING & SESSION LOGIC

### Middleware Protection

Update `/lib/supabase/middleware.ts` to ensure:
- Normal users and employees cannot access `/secure-admin-gateway/*`
- Admin sessions (created by secure admin login) required for `/secure-admin-gateway/*`
- Within admin sessions:
  - If `is_super_user = true`: default route → `/secure-admin-gateway/dashboard`
  - If `is_super_user = false`: default route → `/secure-admin-gateway/review`

### Session Management

Reuse existing admin session helpers (e.g., `/lib/auth/admin-session.ts`).

**DO NOT introduce a second, conflicting auth system.**

---

## 5) ADMIN REVIEW CENTER (LETTER REVIEW & EDIT)

**CRITICAL: There is only ONE admin area at `/secure-admin-gateway/` - all admin functions live here.**

### Review List Page

**Route:** `/app/secure-admin-gateway/dashboard/page.tsx` (Letters/Review tab)

Shows letters needing review (`status = 'pending_review'`):
- Letter title
- User/subscriber name or email
- Created date
- Current status
- Link to detailed view

### Review & Edit Page

**Route:** `/app/secure-admin-gateway/dashboard/letters/[id]/page.tsx`

Shows full letter details:
- Subscriber info (from `profiles`)
- Intake data (from `letters.intake_data`)
- AI-generated draft content
- **Rich text editor for manual editing** (use existing rich editor component or integrate Tiptap/Lexical)

**Workflow:**
1. Admin views AI-generated draft
2. Admin manually edits content in rich editor
3. Admin clicks "Save Changes" → updates `letters.reviewed_content`
4. Admin clicks "Approve" → updates status to `approved`, commits final text

**Actions:**
- **Save Changes** → Update `letters.reviewed_content` with edited content
- **Approve** → Update status to approved, commit final edited text
- **Reject** → Update status to rejected

**For each action:**
- Insert row into `letter_audit_trail`:
  - `letter_id`
  - `performed_by` (current admin)
  - `old_status`
  - `new_status`
  - optional notes/metadata

### Rich Editor Requirements

- Use existing rich text editor component if available in `/components/ui/`
- If not available, integrate **Tiptap** or **Lexical** editor
- Must support:
  - Text formatting (bold, italic, underline)
  - Headings and paragraphs
  - Lists (bullet, numbered)
  - Legal document formatting
- Editor content saves to `letters.reviewed_content`
- Show both original AI draft and edited version side-by-side or toggle view

### Requirements

Review Center must:
- Only be accessible to admins (`role = 'admin'`)
- Respect the secure admin session
- Use existing Supabase helpers and types
- Integrate visually with existing dark admin UI
- All review functions live in the single admin area at `/secure-admin-gateway/dashboard/`

---

## 6) SUPER ADMIN – USER MANAGEMENT & PROMOTION

### Users Tab

In existing secure admin dashboard (`/app/secure-admin-gateway/dashboard/...`):

Add new "Users" section displaying:
- `full_name`
- `email`
- `role`
- `is_super_user`

### Promote to Admin

For non-admin users:
- Show "Promote to Admin" button
- Only visible/actionable when current admin has `is_super_user = true`

**Behavior:**
- Updates selected user's `profiles`:
  - `role = 'admin'`
  - `is_super_user = false`
- Use existing mutation patterns (server actions, API routes)
- Respect RLS and Supabase policies

Super admins can view all admin accounts and their super admin status.

---

## 7) SKELETON LOADERS (NO BLANK WHITE SCREENS)

Add `loading.tsx` files for:
- `/app/dashboard/` (subscriber dashboard)
- `/app/secure-admin-gateway/dashboard/` (super admin dashboard)
- `/app/secure-admin-gateway/review/` (review center list)
- `/app/secure-admin-gateway/review/[id]/` (single letter review)

### Requirements

- Match existing design system (Tailwind, shadcn)
- Create reusable skeleton component in `/components/ui/`
- Render "fake" rows/blocks representing final layout
- No blank white pages during loading

---

## 8) DATABASE & RLS CHANGES

### Migration Guidelines

When creating new migrations:

1. **Keep all existing tables and columns intact**
2. **Create idempotent migrations** (use guards like `IF NOT EXISTS`)
3. **Place in `/supabase/migrations/`** with timestamp naming
4. **Do NOT paste existing SQL** - write new migrations assuming current schema exists

### Required Changes

- Confirm `role` enum type exists with values:
  - `subscriber`
  - `employee`
  - `admin`
- Confirm `profiles.is_super_user` exists

### RLS Policy Updates

- **Subscribers:** Can only select/insert/update their own letters
- **Admins:** Can select all letters
- **Admins:** Can insert into `letter_audit_trail` on review actions
- **Super admins only:** Can read `security_audit_log` and `security_config`

---

## 9) INTEGRATION RULES – DO NOT BREAK THESE

### Do NOT Modify

- AI letter generation API route (`/api/generate-letter`) and flow
- Existing subscription / Stripe payment flows
- Existing coupon and commission logic
- Basic subscriber and employee dashboards (except adding loading states)

### Do NOT Reintroduce

- Any public "Sign up as admin" flow
- Any direct admin access via `/dashboard/admin`

### Admin Access Pattern

Everything admin-related must go through:
```
/secure-admin-gateway/login → secure admin session → protected admin routes
```

---

## 10) LETTER STATUS WORKFLOW

### Complete Status Flow

```
draft → generating → pending_review → under_review → approved/rejected/completed/failed
```

### Status Descriptions

- **draft:** Initial state
- **generating:** AI is creating the draft
- **pending_review:** Awaiting admin review
- **under_review:** Admin has started reviewing
- **approved:** Letter approved by admin
- **rejected:** Letter rejected by admin
- **completed:** Full workflow complete
- **failed:** Generation or processing failed

---

## 11) AI INTEGRATION

### Current Implementation

- Uses Vercel AI SDK with OpenAI
- Model: `gpt-4-turbo`
- Endpoint: `/api/generate-letter`
- Environment variable: `OPENAI_API_KEY`

### AI SDK Usage Pattern

```typescript
import { openai } from "@ai-sdk/openai"
import { generateText } from "ai"

const { text } = await generateText({
  model: openai("gpt-4-turbo"),
  system: "System prompt here",
  prompt: "User prompt here",
  temperature: 0.7,
  maxTokens: 2048,
})
```

---

## 12) FREE TRIAL SYSTEM

### Implementation

- First letter is free (no subscription required)
- Check letter count before generation
- If `count = 0`, allow generation without subscription
- After first letter, require active subscription with credits

### Subscription Plans

- **One-time:** $299 (1 letter)
- **Monthly Standard:** $299/month (4 letters)
- **Yearly Premium:** $599/year (8 letters)

---

## 13) CODING STANDARDS

### TypeScript

- Use strict TypeScript
- Define proper types for all data
- Use existing types from `/lib/database.types.ts`

### Components

- Use existing shadcn/ui components from `/components/ui/`
- Follow existing component patterns
- Keep components modular and reusable

### API Routes

- Use Next.js App Router conventions
- Implement proper error handling
- Return consistent JSON responses
- Check authentication first
- Validate input data

### Supabase Patterns

```typescript
// Always use server-side client for API routes
import { createClient } from "@/lib/supabase/server"

// Always check auth first
const supabase = await createClient()
const { data: { user }, error } = await supabase.auth.getUser()
if (error || !user) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
}
```

---

## 14) SECURITY BEST PRACTICES

### Row Level Security (RLS)

- Always enable RLS on tables
- Use `auth.uid()` for user-specific policies
- Create separate policies for each operation (SELECT, INSERT, UPDATE, DELETE)
- Use helper function `get_user_role()` for role checks

### Environment Variables

Required in `.env.local`:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SERVICE_ROLE_KEY`
- `OPENAI_API_KEY`
- `GEMINI_API_KEY`
- `STRIPE_SECRET_KEY`
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`

### Audit Trail

Always log important actions to `letter_audit_trail`:
```typescript
await supabase.rpc('log_letter_audit', {
  p_letter_id: letterId,
  p_action: 'approved',
  p_old_status: 'pending_review',
  p_new_status: 'approved',
  p_notes: 'Letter approved by admin'
})
```

---

## 15) EMPLOYEE COUPON SYSTEM

### Auto-Generation

- Trigger: When new employee profile created
- Format: `EMP-XXXXXX` (6 character hash)
- Discount: 20%
- Auto-active: `is_active = true`

### Commission Structure

- Commission rate: 5%
- Points: 1 point per use
- Status: `pending` → `paid`

---

## DEVELOPMENT ENVIRONMENT

This is a GitHub Codespaces environment with:
- Node.js 18+
- pnpm package manager
- PostgreSQL client tools
- Supabase CLI
- Python 3 (for Jupyter notebooks)
- Go, LLDB debugger support

Always respect the existing environment configuration and don't make assumptions about paths or tool availability.
